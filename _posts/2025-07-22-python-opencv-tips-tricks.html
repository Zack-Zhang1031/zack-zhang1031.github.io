<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Python + OpenCV 日常小技巧与常见坑整理</title>
    <meta name="description" content="Python + OpenCV 日常小技巧与常见坑整理">
    <meta name="date" content="2025-07-22">
    <meta name="tags" content="Python, 基础">
    <!-- 引入KaTeX支持数学公式渲染 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
            onload="renderMathInElement(document.body, {delimiters: [{left:'$$', right:'$$', display:true}, {left:'$', right:'$', display:false}]});"></script>
    <style>
        body { font-family: "Microsoft YaHei", "Helvetica Neue", Arial, "Liberation Sans", "PingFang SC", sans-serif; background: #fcfcfc; color: #222; padding: 2em; }
        code, pre { background: #f4f4f4; border-radius: 4px; font-size: 1em; }
        table { border-collapse: collapse; margin: 1em 0; width: 100%; }
        th, td { border: 1px solid #bbb; padding: 8px 14px; }
        th { background: #f0f0f0; }
        h1, h2, h3, h4 { color: #4e67e9; }
        .katex { font-size: 1.1em; }
    </style>
</head>
<body>
<h1>Python + OpenCV 日常小技巧与常见坑整理</h1>
<p><strong>更新时间：</strong>2025-07-22</p>
<p><strong>标签：</strong>Python，基础</p>

<h2>前言</h2>
<p>
本篇博客系统梳理了图像处理中常见的几何变换，包括仿射变换、旋转矩阵、剪切、平移、缩放等基础理论与OpenCV实战应用，并对常见问题做了详细解答和矩阵推导。适合视觉、AI、Python图像处理爱好者查阅与积累！
</p>

<hr/>

<h2>1. NumPy与OpenCV加法的区别</h2>

<h3>1.1 NumPy加法是取模吗？</h3>
<ul>
  <li>普通加法是逐元素相加。</li>
  <li>对于<code>uint8</code>等定长整型，结果溢出时会“取模”——即 260 % 256 = 4。</li>
</ul>
<pre><code>import numpy as np
a = np.array([250], dtype=np.uint8)
b = np.array([10], dtype=np.uint8)
print(a + b)  # [4]
</code></pre>

<h3>1.2 OpenCV加法是饱和加法</h3>
<ul>
  <li><code>cv2.add(a, b)</code> 超过255自动截断为255。</li>
</ul>
<pre><code>import cv2
print(cv2.add(a, b))  # [255]
</code></pre>

<hr/>

<h2>2. 图像灰度化最大值法案例</h2>

<pre><code>import cv2
pig = cv2.imread("../images/pig.png")
img = pig.max(axis=2)  # BGR三通道最大分量法
cv2.imshow("gray", img)
cv2.waitKey(0)
cv2.destroyAllWindows()
</code></pre>
<ul>
  <li>亮度偏高，区别于标准加权灰度。</li>
</ul>

<hr/>

<h2>3. 常见二维变换矩阵的推导</h2>

<h3>3.1 平移（Translation）</h3>
<p>不能用2x2方阵实现，需齐次坐标：</p>
<div>
$$
\begin{bmatrix}
x' \\
y' \\
1
\end{bmatrix}
=
\begin{bmatrix}
1 & 0 & t_x \\
0 & 1 & t_y \\
0 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
x \\
y \\
1
\end{bmatrix}
$$
</div>

<h3>3.2 缩放（Scaling）</h3>
<p>2x2线性变换：</p>
<div>
$$
\begin{bmatrix}
s_x & 0 \\
0 & s_y
\end{bmatrix}
$$
</div>
<p>也可用齐次坐标表达。</p>

<h3>3.3 旋转（Rotation）</h3>
<p>推导过程：极坐标→三角恒等式展开</p>
<div>
$$
x = x_0 \cos\theta + y_0 \sin\theta \\
y = -x_0 \sin\theta + y_0 \cos\theta
$$
</div>
<p>矩阵写法：</p>
<div>
$$
\begin{bmatrix}
x \\
y
\end{bmatrix}
=
\begin{bmatrix}
\cos\theta & \sin\theta \\
-\sin\theta & \cos\theta
\end{bmatrix}
\begin{bmatrix}
x_0 \\
y_0
\end{bmatrix}
$$
</div>

<h3>3.4 剪切（Shear）</h3>
<p>x方向剪切：</p>
<div>
$$
\begin{bmatrix}
x' \\
y'
\end{bmatrix}
=
\begin{bmatrix}
1 & k \\
0 & 1
\end{bmatrix}
\begin{bmatrix}
x \\
y
\end{bmatrix}
$$
</div>
<p>y方向剪切：</p>
<div>
$$
\begin{bmatrix}
x' \\
y'
\end{bmatrix}
=
\begin{bmatrix}
1 & 0 \\
k & 1
\end{bmatrix}
\begin{bmatrix}
x \\
y
\end{bmatrix}
$$
</div>

<h3>3.5 综合仿射变换（Affine）</h3>
<p>齐次坐标统一表示：</p>
<div>
$$
\begin{bmatrix}
x' \\
y' \\
1
\end{bmatrix}
=
\begin{bmatrix}
a_{11} & a_{12} & t_x \\
a_{21} & a_{22} & t_y \\
0 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
x \\
y \\
1
\end{bmatrix}
$$
</div>

<hr/>

<h2>4. 各类变换矩阵对比速查表</h2>
<table>
<thead>
<tr>
<th>变换</th>
<th>2×2部分</th>
<th>平移</th>
<th>3×3齐次矩阵</th>
</tr>
</thead>
<tbody>
<tr>
<td>平移</td>
<td>单位阵</td>
<td><span class="katex">\(t_x, t_y\)</span></td>
<td>
<span class="katex">
\(\begin{bmatrix}1&0&t_x\\0&1&t_y\\0&0&1\end{bmatrix}\)
</span>
</td>
</tr>
<tr>
<td>缩放</td>
<td>
<span class="katex">
\(\begin{bmatrix}s_x&0\\0&s_y\end{bmatrix}\)
</span>
</td>
<td>0</td>
<td>
<span class="katex">
\(\begin{bmatrix}s_x&0&0\\0&s_y&0\\0&0&1\end{bmatrix}\)
</span>
</td>
</tr>
<tr>
<td>旋转</td>
<td>
<span class="katex">
\(\begin{bmatrix}\cos\theta&\sin\theta\\-\sin\theta&\cos\theta\end{bmatrix}\)
</span>
</td>
<td>0</td>
<td>
<span class="katex">
\(\begin{bmatrix}\cos\theta&\sin\theta&0\\-\sin\theta&\cos\theta&0\\0&0&1\end{bmatrix}\)
</span>
</td>
</tr>
<tr>
<td>剪切(x)</td>
<td>
<span class="katex">
\(\begin{bmatrix}1&k\\0&1\end{bmatrix}\)
</span>
</td>
<td>0</td>
<td>
<span class="katex">
\(\begin{bmatrix}1&k&0\\0&1&0\\0&0&1\end{bmatrix}\)
</span>
</td>
</tr>
<tr>
<td>剪切(y)</td>
<td>
<span class="katex">
\(\begin{bmatrix}1&0\\k&1\end{bmatrix}\)
</span>
</td>
<td>0</td>
<td>
<span class="katex">
\(\begin{bmatrix}1&0&0\\k&1&0\\0&0&1\end{bmatrix}\)
</span>
</td>
</tr>
</tbody>
</table>

<hr/>

<h2>5. OpenCV仿射变换实战与问题解析</h2>

<h3>5.1 warpAffine 的参数</h3>
<pre><code>dst = cv2.warpAffine(img, M, (w, h))
</code></pre>
<ul>
  <li>img：原图</li>
  <li>M：2×3 仿射矩阵（手动写，或三点法<code>cv2.getAffineTransform(pts1, pts2)</code>自动求）</li>
  <li>(w, h)：输出图像宽高（宽在前！）</li>
</ul>

<h3>5.2 如何定义M？</h3>
<ul>
  <li><strong>平移</strong>：<code>M = np.float32([[1,0,tx],[0,1,ty]])</code></li>
  <li><strong>缩放</strong>：<code>M = np.float32([[sx,0,0],[0,sy,0]])</code></li>
  <li><strong>旋转</strong>：<code>M = cv2.getRotationMatrix2D(center, angle, scale)</code>（含旋转+缩放+自动平移）</li>
  <li><strong>剪切</strong>：<code>M = np.float32([[1,k,0],[0,1,0]])</code></li>
  <li><strong>任意仿射</strong>：三对点法
  <pre><code>M = cv2.getAffineTransform(pts1, pts2)
  </code></pre>
  </li>
</ul>

<h3>5.3 综合仿射变换实例</h3>
<pre><code>pts1 = np.float32([[0,0],[cols-1,0],[0,rows-1]])
pts2 = np.float32([[50,50],[cols-100,100],[100,rows-100]])
M = cv2.getAffineTransform(pts1, pts2)
dst = cv2.warpAffine(img, M, (cols, rows))
</code></pre>

<hr/>

<h2>6. 旋转与角度正负方向</h2>
<ul>
  <li>数学约定：逆时针为正角度，顺时针为负角度（和单位圆、三角函数方向一致）。</li>
  <li>三角恒等式推导：</li>
</ul>
<div>
$$
\cos(A-B) = \cos A \cos B + \sin A \sin B \\
\sin(A-B) = \sin A \cos B - \cos A \sin B
$$
</div>

<hr/>

<h2>7. 插值方法小结</h2>
<table>
<thead>
<tr>
<th>方法</th>
<th>OpenCV常量</th>
<th>特点</th>
</tr>
</thead>
<tbody>
<tr>
<td>最近邻</td>
<td><code>cv2.INTER_NEAREST</code></td>
<td>快，马赛克感强</td>
</tr>
<tr>
<td>双线性</td>
<td><code>cv2.INTER_LINEAR</code></td>
<td>默认，平滑度好</td>
</tr>
<tr>
<td>双三次</td>
<td><code>cv2.INTER_CUBIC</code></td>
<td>更平滑，慢</td>
</tr>
<tr>
<td>Lanczos</td>
<td><code>cv2.INTER_LANCZOS4</code></td>
<td>超平滑，最慢</td>
</tr>
</tbody>
</table>

<hr/>

<h2>8. 常见问题与答疑总结</h2>

<h3>8.1 仿射变换与旋转矩阵的区别</h3>
<ul>
  <li>仿射变换：包含旋转、缩放、剪切、平移，线性部分+平移部分</li>
  <li>旋转矩阵：仿射的一种，只旋转，无平移、缩放、剪切</li>
</ul>

<h3>8.2 warpAffine命名含义</h3>
<ul>
  <li>"warp" = 扭曲、映射</li>
  <li>"Affine" = 仿射</li>
  <li>合起来就是“仿射变换映射”</li>
</ul>

<h3>8.3 为什么逆时针为正、顺时针为负？</h3>
<ul>
  <li>因为数学单位圆和三角函数约定如此</li>
</ul>

<h3>8.4 剪切（Shear）怎么实现？</h3>
<ul>
  <li>x剪切：<code>M = [[1, k, 0], [0, 1, 0]]</code></li>
  <li>y剪切：<code>M = [[1, 0, 0], [k, 1, 0]]</code></li>
  <li>用<code>cv2.warpAffine()</code>即可实现图像斜拉变形</li>
</ul>

<hr/>

<h2>9. 旋转与仿射变换的方阵推导过程</h2>

<h3>9.1 二维旋转矩阵的方阵推导</h3>
<p>假设有平面上的点 $P_0(x_0, y_0)$，以原点 O(0, 0) 为中心，逆时针旋转 $\theta$ 角度，问新点 $P(x, y)$ 如何表示？</p>
<p>极坐标法：</p>
<div>
$$
x_0 = r \cos\alpha \\
y_0 = r \sin\alpha
$$

旋转后，新极角变为 $\alpha - \theta$：

$$
x = r \cos(\alpha - \theta) \\
y = r \sin(\alpha - \theta)
$$
</div>

<p>利用三角恒等式展开：</p>
<div>
$$
\cos(A - B) = \cos A \cos B + \sin A \sin B\\
\sin(A - B) = \sin A \cos B - \cos A \sin B
$$
</div>
<div>
$$
x = x_0\cos\theta + y_0\sin\theta \\
y = y_0\cos\theta - x_0\sin\theta
$$
</div>
<p>矩阵表达：</p>
<div>
$$
\begin{bmatrix}
x \\
y
\end{bmatrix} =
\begin{bmatrix}
\cos\theta & \sin\theta \\
-\sin\theta & \cos\theta
\end{bmatrix}
\begin{bmatrix}
x_0 \\
y_0
\end{bmatrix}
$$
</div>

<h3>9.2 齐次坐标下的方阵推导（仿射变换）</h3>
<p>齐次坐标下，仿射变换可以用 3×3 方阵统一表达：</p>
<div>
$$
\begin{bmatrix}
x' \\
y' \\
1
\end{bmatrix} =
\begin{bmatrix}
a_{11} & a_{12} & t_x \\
a_{21} & a_{22} & t_y \\
0 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
x \\
y \\
1
\end{bmatrix}
$$
</div>
<p>其中前2行2列是线性变换（旋转、缩放、剪切），第3列是平移，最后一行保证矩阵可乘。</p>

<hr/>

<h2>10. 参考与进阶</h2>
<ul>
  <li><a href="https://docs.opencv.org/4.x/da/d6e/tutorial_py_geometric_transformations.html" target="_blank">OpenCV官方文档-几何变换</a></li>
  <li><a href="https://numpy.org/doc/stable/user/basics.types.html" target="_blank">NumPy数据类型与溢出规则</a></li>
  <li>线性代数、矩阵变换相关教材</li>
</ul>

</body>
</html>
